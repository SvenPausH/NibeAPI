--- DB Upgrade 
CREATE TABLE IF NOT EXISTS `nibe_system_config` (
  `config_key` VARCHAR(50) PRIMARY KEY,
  `value` TEXT,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_updated_at` (`updated_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;


INSERT INTO `nibe_system_config` (`config_key`, `value`) 
VALUES ('update_lock', '0')
ON DUPLICATE KEY UPDATE `value` = '0';


-- Bestehende Tabellen erweitern
ALTER TABLE nibe_datenpunkte 
  ADD COLUMN deviceId INT(10) DEFAULT NULL AFTER id,
  ADD KEY idx_device (deviceId),
  ADD CONSTRAINT fk_datenpunkt_device FOREIGN KEY (deviceId) 
    REFERENCES nibe_device(deviceId) ON DELETE SET NULL;

ALTER TABLE nibe_datenpunkte_log 
  ADD COLUMN deviceId INT(10) DEFAULT NULL AFTER id,
  ADD KEY idx_device (deviceId),
  ADD CONSTRAINT fk_log_device FOREIGN KEY (deviceId) 
    REFERENCES nibe_device(deviceId) ON DELETE SET NULL;


