# Upgrade Guide: v3.2.00 â†’ v3.4.00 (Multi-Device Support)

## ðŸŽ¯ Was ist neu in v3.4.00?

### Hauptfeatures
1. **Multi-Device Support** - UnterstÃ¼tzung fÃ¼r mehrere Nibe-GerÃ¤te
2. **Device-Discovery** - Automatische Erkennung aller GerÃ¤te im Netzwerk
3. **Notifications-System** - Anzeige und Verwaltung von Alarmen/Warnungen
4. **Device-Auswahl** - Dropdown zur Auswahl des aktiven GerÃ¤ts
5. **Automatisches Polling** - Notifications werden alle 5 Minuten geprÃ¼ft

## ðŸ“‹ Installations-Checkliste

### Schritt 1: Datenbank aktualisieren

```sql
-- Neue Tabellen erstellen
USE nibeapi;

-- Tabelle: nibe_device
CREATE TABLE nibe_device (
  deviceId INT(10) NOT NULL PRIMARY KEY,
  aidMode VARCHAR(10) NOT NULL,
  smartMode VARCHAR(10) NOT NULL,
  serialNumber VARCHAR(15) NOT NULL UNIQUE,
  name VARCHAR(50) NOT NULL,
  manufacturer VARCHAR(50) NOT NULL,
  firmwareId VARCHAR(15) NOT NULL,
  last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabelle: nibe_notifications
CREATE TABLE nibe_notifications (
  id BIGINT(20) NOT NULL AUTO_INCREMENT PRIMARY KEY,
  deviceId INT(10) NOT NULL,
  alarmId INT(10) NOT NULL,
  description VARCHAR(255) NOT NULL,
  header VARCHAR(255) NOT NULL,
  severity INT(10) NOT NULL,
  time DATETIME NOT NULL,
  equipName VARCHAR(50) NOT NULL,
  resetNotifications TIMESTAMP NULL DEFAULT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY unique_notification (deviceId, alarmId, time),
  KEY idx_device_time (deviceId, time DESC),
  CONSTRAINT fk_notification_device FOREIGN KEY (deviceId) 
    REFERENCES nibe_device(deviceId) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Bestehende Tabellen erweitern
ALTER TABLE nibe_datenpunkte 
  ADD COLUMN deviceId INT(10) DEFAULT NULL AFTER id,
  ADD KEY idx_device (deviceId),
  ADD CONSTRAINT fk_datenpunkt_device FOREIGN KEY (deviceId) 
    REFERENCES nibe_device(deviceId) ON DELETE SET NULL;

ALTER TABLE nibe_datenpunkte_log 
  ADD COLUMN deviceId INT(10) DEFAULT NULL AFTER id,
  ADD KEY idx_device (deviceId),
  ADD CONSTRAINT fk_log_device FOREIGN KEY (deviceId) 
    REFERENCES nibe_device(deviceId) ON DELETE SET NULL;
```

**Alternative:** Importieren Sie die komplette `nibeapi.sql` neu (Backup vorher!)

### Schritt 2: config.php anpassen

**ALT (v3.3):**
```php
define('API_URL', 'https://192.168.1.44:8443/api/v1/devices/0/points');
```

**NEU (v3.4):**
```php
// API Basis-URL (nur IP/Hostname, keine Pfade!)
define('API_BASE_URL', 'https://192.168.1.44:8443');
define('API_VERSION', 'v1');

// Automatisch generierte Endpoints
define('API_DEVICES_ENDPOINT', API_BASE_URL . '/api/' . API_VERSION . '/devices');

// Notifications Update-Intervall (in Sekunden, 0 = deaktiviert)
define('NOTIFICATIONS_CHECK_INTERVAL', 300); // Alle 5 Minuten
